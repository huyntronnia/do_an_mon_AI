<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Snake AI Visualization (Big Mode)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        @font-face {
            font-family: 'Akira';
            src: url("/static/akiraexpanded.otf") format('opentype');
        }

        :root {
            --bg-color: #0a0a0a;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --neon-green: #4CAF50;
        }

        body {
            background-color: var(--bg-color);
            
            /* --- TẠO BACKGROUND TECH GRID BẰNG CSS (KHÔNG CẦN ẢNH) --- */
            background-image: 
                linear-gradient(rgba(76, 175, 80, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(76, 175, 80, 0.05) 1px, transparent 1px);
            background-size: 40px 40px; /* Kích thước ô lưới */
            
            /* Hiệu ứng tối dần ở 4 góc (Vignette) để tập trung vào giữa */
            box-shadow: inset 0 0 200px rgba(0,0,0,0.9);
            
            color: var(--text-color);
            font-family: 'Roboto Mono', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .header-container { text-align: center; margin-bottom: 20px; z-index: 2; }

        h1 {
            font-family: 'Akira', sans-serif !important;
            color: var(--neon-green);
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 0 0 15px rgba(76, 175, 80, 0.6);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .nav-link {
            display: inline-block;
            margin-top: 10px;
            color: #ccc;
            text-decoration: none;
            font-size: 0.9rem;
            border: 1px solid #444;
            padding: 5px 15px;
            border-radius: 4px;
            background: rgba(0,0,0,0.8);
            transition: 0.3s;
        }
        .nav-link:hover {
            background: var(--neon-green);
            color: #000;
            border-color: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green);
        }

        .main-container {
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            max-width: 1600px;
            flex-wrap: wrap;
            z-index: 2;
        }

        .game-section { display: flex; flex-direction: column; width: 640px; }

        .canvas-wrapper {
            padding: 5px;
            border: 2px solid var(--neon-green);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
            border-radius: 4px;
            background: #000;
        }

        canvas { display: block; background-color: #000; }

        .scoreboard {
            margin-top: 15px;
            background-color: #333;
            color: #fff;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #444;
        }
        
        .score-val { color: var(--neon-green); margin-left: 5px; }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            font-family: 'Akira', sans-serif !important;
            padding: 15px;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: #fff;
            text-transform: uppercase;
            font-weight: bold;
            transition: filter 0.2s;
        }
        button:hover { filter: brightness(1.2); transform: translateY(-2px); }
        
        .btn-astar { background-color: #2196F3; }
        .btn-hybrid { background-color: #00BCD4; color: #000; }
        .btn-hamilton { background-color: #9C27B0; }
        .btn-rl { background-color: #FF9800; color: #000; }
        .btn-stop { grid-column: span 2; background-color: #f44336; font-size: 1rem; margin-top: 5px; }

        .info-section {
            flex: 1;
            min-width: 450px;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .panel-header h3 {
            margin: 0;
            font-family: 'Roboto Mono', monospace;
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
        }

        .comparison-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .comparison-table th { text-align: left; padding: 12px 5px; color: #888; text-transform: uppercase; font-size: 0.75rem; border-bottom: 1px solid #444; }
        .comparison-table td { padding: 15px 5px; border-bottom: 1px solid #333; vertical-align: middle; }
        .comparison-table tr:last-child td { border-bottom: none; }

        .col-astar { color: #2196F3; font-weight: bold; }
        .col-hybrid { color: #00BCD4; font-weight: bold; }
        .col-hamilton { color: #9C27B0; font-weight: bold; }
        .col-dql { color: #FF9800; font-weight: bold; }

        .val-bad { color: #f44336; }
        .val-good { color: #4CAF50; }
        .val-best { color: #fff; font-weight: bold; }
        .val-avg { color: #ccc; }

    </style>
</head>
<body>
    <div class="header-container">
        <h1><i class="fas fa-snake" style="margin-right: 15px;"></i> Snake AI Visualization</h1>
        <a href="/compare" class="nav-link"><i class="fas fa-balance-scale"></i> Go to Dual Comparison Mode</a>
    </div>

    <div class="main-container">
        <!-- GAME SECTION -->
        <div class="game-section">
            <div class="canvas-wrapper">
                <canvas id="gameCanvas" width="640" height="480"></canvas>
            </div>
            <div class="scoreboard">
                Score: <span id="score" class="score-val">0</span>
                <span style="color: #666; margin: 0 10px;">|</span>
                Algo: <span id="algo-name" style="color: #fff;">Ready</span>
            </div>
            <div class="controls-grid">
                <button class="btn-astar" onclick="startGame('astar')">Basic A*</button>
                <button class="btn-hybrid" onclick="startGame('hybrid')">Hybrid A*</button>
                <button class="btn-hamilton" onclick="startGame('hamilton')">Hamiltonian</button>
                <button class="btn-rl" onclick="startGame('rl')">Deep Q-Learning</button>
                <button class="btn-stop" onclick="stopGame()">STOP GAME</button>
            </div>
        </div>

        <!-- INFO SECTION -->
        <div class="info-section">
            <div class="panel-header">
                <i class="fas fa-chart-bar" style="color: #4CAF50;"></i>
                <h3>So sánh Hiệu suất Thuật toán</h3>
            </div>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th style="width: 20%;">TIÊU CHÍ</th>
                        <th class="col-astar">BASIC A*</th>
                        <th class="col-hybrid">HYBRID (A*++)</th>
                        <th class="col-hamilton">HAMILTONIAN</th>
                        <th class="col-dql">DEEP Q-LEARNING</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Max Score</strong></td>
                        <td class="val-bad">Thấp (Dễ chết)</td>
                        <td class="val-good">Cao (Gần Max)</td>
                        <td class="val-best">Tối đa (Max)</td>
                        <td class="val-avg">Cao</td>
                    </tr>
                    <tr>
                        <td><strong>Survival Rate</strong></td>
                        <td class="val-bad">Thấp (Kẹt góc)</td>
                        <td class="val-good">Rất Cao (Safety)</td>
                        <td class="val-best">100% (Tuyệt đối)</td>
                        <td class="val-avg">Tùy model</td>
                    </tr>
                    <tr>
                        <td><strong>Steps / Food</strong></td>
                        <td class="val-best">Tối ưu nhất</td>
                        <td class="val-good">Tối ưu</td>
                        <td class="val-bad">Rất nhiều (Tệ)</td>
                        <td class="val-avg">Trung bình</td>
                    </tr>
                    <tr>
                        <td><strong>Computation</strong></td>
                        <td class="val-best">Rất nhanh</td>
                        <td class="val-good">Nhanh</td>
                        <td class="val-good">Rất nhanh (Pre-calc)</td>
                        <td class="val-bad">Chậm (Cần GPU)</td>
                    </tr>
                    <tr>
                        <td><strong>Logic</strong></td>
                        <td>Tìm đường ngắn nhất</td>
                        <td>A* + BFS (Thoát hiểm)</td>
                        <td>Chu trình cố định</td>
                        <td>Học máy (Neural Net)</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const algoNameEl = document.getElementById('algo-name');
        const CELL_SIZE = 20;
        const GRID_W = canvas.width / CELL_SIZE; 
        const GRID_H = canvas.height / CELL_SIZE;
        let snake = [], food = {}, currentAlgo = '', gameInterval = null, isProcessing = false;

        function initGame() {
            snake = [{x: 15, y: 12}, {x: 14, y: 12}, {x: 13, y: 12}];
            spawnFood();
            draw();
        }

        function spawnFood() {
            while (true) {
                food = {x: Math.floor(Math.random()*GRID_W), y: Math.floor(Math.random()*GRID_H)};
                if (!snake.some(s => s.x === food.x && s.y === food.y)) break;
            }
        }

        function draw() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // Food
            ctx.fillStyle = '#ff4444';
            ctx.shadowBlur = 15; ctx.shadowColor = "red";
            ctx.fillRect(food.x * CELL_SIZE, food.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            ctx.shadowBlur = 0;
            // Snake
            snake.forEach((segment, index) => {
                ctx.fillStyle = index === 0 ? '#4CAF50' : '#81C784';
                if(index===0) { ctx.shadowBlur=10; ctx.shadowColor="#4CAF50"; }
                ctx.fillRect(segment.x * CELL_SIZE, segment.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                ctx.shadowBlur = 0;
                ctx.strokeStyle = '#121212';
                ctx.strokeRect(segment.x * CELL_SIZE, segment.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            });
        }

        async function gameStep() {
            if (isProcessing) return;
            isProcessing = true;
            const payload = {snake: snake.map(s=>[s.x, s.y]), food: [food.x, food.y], board_size: {width: GRID_W, height: GRID_H}, algorithm: currentAlgo};
            try {
                const response = await fetch('http://127.0.0.1:8001/predict', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
                const data = await response.json();
                const move = data.move;
                if (move[0] === 0 && move[1] === 0) { stopGame(); alert(`Game Over! Score: ${scoreEl.innerText} (Stuck)`); return; }
                const head = snake[0];
                const newHead = {x: head.x + move[0], y: head.y + move[1]};
                if(newHead.x < 0 || newHead.x >= GRID_W || newHead.y < 0 || newHead.y >= GRID_H || snake.some(s=>s.x===newHead.x && s.y===newHead.y)) {
                    stopGame(); alert(`Game Over! Score: ${scoreEl.innerText}`); return;
                }
                snake.unshift(newHead);
                if (newHead.x === food.x && newHead.y === food.y) { scoreEl.innerText = parseInt(scoreEl.innerText)+1; spawnFood(); } else { snake.pop(); }
                draw();
            } catch (error) { console.error("Error:", error); stopGame(); }
            isProcessing = false;
        }

        function startGame(algo) {
            stopGame();
            currentAlgo = algo;
            let name = ""; let speed = 60;
            if(algo === 'astar') { name="Basic A*"; speed=80; }
            if(algo === 'hybrid') { name="Hybrid A*"; speed=50; } 
            if(algo === 'hamilton') { name="Hamiltonian"; speed=20; } 
            if(algo === 'rl') { name="Deep Q-Learning"; speed=60; }
            algoNameEl.innerText = name;
            initGame(); scoreEl.innerText = 0;
            gameInterval = setInterval(gameStep, speed);
        }

        function stopGame() { clearInterval(gameInterval); isProcessing=false; algoNameEl.innerText="Stopped"; }
        initGame();
    </script>
</body>
</html>